<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0">
  <title>HB Review Portal - Verified Flows</title>
  <style>
    :root {
      --gray-950: oklch(12% 0.01 60);
      --gray-900: oklch(18% 0.01 60);
      --gray-800: oklch(25% 0.01 60);
      --gray-700: oklch(35% 0.01 60);
      --gray-600: oklch(45% 0.01 60);
      --gray-500: oklch(55% 0.01 60);
      --gray-400: oklch(65% 0.01 60);
      --gray-300: oklch(75% 0.01 60);
      --gray-200: oklch(85% 0.01 60);
      --gray-100: oklch(92% 0.01 60);

      --green-600: oklch(55% 0.15 145);
      --red-600: oklch(50% 0.18 25);
      --blue-600: oklch(55% 0.15 250);

      --color-bg: var(--gray-950);
      --color-surface: var(--gray-900);
      --color-surface-raised: var(--gray-800);
      --color-border: var(--gray-800);
      --color-text: var(--gray-100);
      --color-text-dim: var(--gray-400);
      --color-primary: var(--green-600);
      --color-accent: var(--blue-600);
      --color-bad: var(--red-600);

      --space-xs: 4px;
      --space-sm: 8px;
      --space-md: 16px;
      --space-lg: 24px;
      --space-xl: 32px;

      --font-mono: 'SF Mono', 'Monaco', monospace;
      --font-sans: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: var(--font-sans);
      font-size: 16px;
      line-height: 1.5;
      background: var(--color-bg);
      color: var(--color-text);
      -webkit-font-smoothing: antialiased;
      font-weight: 350;
    }

    .header {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      background: var(--color-bg);
      border-bottom: 1px solid var(--color-border);
      z-index: 100;
      padding: var(--space-md);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .breadcrumb {
      font-size: 14px;
      color: var(--color-text-dim);
    }

    .zoom-btn {
      font-family: var(--font-sans);
      font-size: 14px;
      font-weight: 500;
      padding: var(--space-sm) var(--space-md);
      background: var(--color-surface);
      border: 1px solid var(--color-border);
      border-radius: 6px;
      color: var(--color-text);
      cursor: pointer;
    }

    .content {
      padding-top: 80px;
      padding-bottom: 180px;
      min-height: 100vh;
    }

    .view {
      display: none;
      padding: var(--space-xl) var(--space-md);
      max-width: 1200px;
      margin: 0 auto;
    }

    .view.active {
      display: block;
    }

    .view-title {
      font-size: 24px;
      font-weight: 600;
      color: var(--color-text);
      margin-bottom: var(--space-sm);
    }

    .view-subtitle {
      font-size: 14px;
      color: var(--color-text-dim);
      margin-bottom: var(--space-xl);
    }

    .source-badge {
      display: inline-block;
      padding: 4px 8px;
      background: var(--color-surface-raised);
      border: 1px solid var(--color-border);
      border-radius: 4px;
      font-size: 11px;
      font-weight: 600;
      color: var(--color-text-dim);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: var(--space-lg);
    }

    .flow-cards {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: var(--space-md);
      margin-bottom: var(--space-xl);
    }

    .flow-card {
      background: var(--color-surface);
      border: 1px solid var(--color-border);
      border-radius: 8px;
      padding: var(--space-lg);
      cursor: pointer;
      transition: all 0.15s ease;
      text-align: left;
      width: 100%;
      font-family: inherit;
      font-size: inherit;
      color: inherit;
    }

    .flow-card:hover {
      background: var(--color-surface-raised);
      border-color: var(--color-text-dim);
    }

    .flow-card:focus {
      outline: 2px solid var(--color-accent);
      outline-offset: 2px;
    }

    .flow-card-title {
      font-size: 18px;
      font-weight: 600;
      color: var(--color-text);
      margin-bottom: var(--space-sm);
    }

    .flow-card-desc {
      font-size: 14px;
      color: var(--color-text-dim);
      line-height: 1.5;
      margin-bottom: var(--space-md);
    }

    .flow-card-source {
      font-size: 11px;
      font-family: var(--font-mono);
      color: var(--color-text-dim);
      margin-bottom: var(--space-sm);
    }

    .flow-card-meta {
      font-size: 13px;
      color: var(--color-text-dim);
    }

    .path-toggle {
      display: flex;
      gap: var(--space-sm);
      margin-bottom: var(--space-xl);
      background: var(--color-surface);
      border: 1px solid var(--color-border);
      border-radius: 6px;
      padding: var(--space-xs);
      width: fit-content;
    }

    .path-btn {
      font-family: var(--font-sans);
      font-size: 14px;
      font-weight: 500;
      padding: var(--space-sm) var(--space-md);
      background: transparent;
      border: none;
      color: var(--color-text-dim);
      cursor: pointer;
      border-radius: 4px;
    }

    .path-btn.active {
      background: var(--color-surface-raised);
      color: var(--color-text);
    }

    .path-btn.good.active {
      color: var(--color-primary);
    }

    .path-btn.bad.active {
      color: var(--color-bad);
    }

    .screen-card {
      background: var(--color-surface);
      border: 1px solid var(--color-border);
      border-radius: 8px;
      padding: var(--space-md);
      margin-bottom: var(--space-md);
      cursor: pointer;
      text-align: left;
      width: 100%;
      font-family: inherit;
      font-size: inherit;
      color: inherit;
      display: block;
    }

    .screen-card:hover {
      background: var(--color-surface-raised);
    }

    .screen-card:focus {
      outline: 2px solid var(--color-accent);
      outline-offset: 2px;
    }

    .screen-label {
      font-size: 12px;
      color: var(--color-text-dim);
      margin-bottom: var(--space-xs);
      font-weight: 600;
      text-transform: uppercase;
    }

    .screen-title {
      font-size: 16px;
      font-weight: 500;
      color: var(--color-text);
      margin-bottom: var(--space-sm);
    }

    .screen-desc {
      font-size: 13px;
      color: var(--color-text-dim);
    }

    .detail-view .screen-title {
      font-size: 28px;
      margin-bottom: var(--space-xl);
    }

    .copy-box {
      background: var(--color-surface);
      border: 1px solid var(--color-border);
      border-radius: 8px;
      padding: var(--space-lg);
      margin-bottom: var(--space-md);
    }

    .copy-box-title {
      font-size: 12px;
      color: var(--color-text-dim);
      margin-bottom: var(--space-sm);
      font-weight: 600;
      text-transform: uppercase;
    }

    .copy-box-content {
      font-size: 15px;
      color: var(--color-text);
      line-height: 1.6;
    }

    .footer {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: var(--color-bg);
      border-top: 1px solid var(--color-border);
      padding: var(--space-md);
      z-index: 100;
    }

    .btn {
      font-family: var(--font-sans);
      font-size: 15px;
      font-weight: 600;
      padding: 14px var(--space-md);
      border: 1px solid var(--color-border);
      border-radius: 6px;
      cursor: pointer;
      width: 100%;
      background: var(--color-surface);
      color: var(--color-text);
    }

    .btn-primary {
      background: var(--color-primary);
      color: var(--gray-950);
      border-color: var(--color-primary);
    }
  </style>
</head>
<body>
  <div class="header">
    <div class="breadcrumb" id="breadcrumb">All Flows</div>
    <button class="zoom-btn" onclick="goBack()" id="backBtn" style="display:none;">Zoom out</button>
  </div>

  <div class="content">
    <!-- Flows Overview -->
    <div class="view flows-view active" id="flowsView">
      <h1 class="view-title">Hibiscus Studio Booking Flows</h1>
      <p class="view-subtitle">Verified flows extracted from source code</p>
      <div class="source-badge">Source: hibiscus-studio-deploy/*.html</div>

      <div class="flow-cards">
        <button class="flow-card" type="button" onclick="openFlow('funnel')">
          <div class="flow-card-title">Event-Type Funnel</div>
          <div class="flow-card-desc">4-step recommendation engine that suggests packages based on event type and guest count</div>
          <div class="flow-card-source">event-type-funnel.html</div>
          <div class="flow-card-meta">4 steps â€¢ Good & bad paths</div>
        </button>

        <button class="flow-card" type="button" onclick="openFlow('main')">
          <div class="flow-card-title">Category-Based Flow (Live)</div>
          <div class="flow-card-desc">Production system with Acuity modal - category selection then package selection</div>
          <div class="flow-card-source">index.html</div>
          <div class="flow-card-meta">2 steps + Acuity â€¢ Good & bad paths</div>
        </button>

        <button class="flow-card" type="button" onclick="openFlow('demo')">
          <div class="flow-card-title">Booking Demo Wizard</div>
          <div class="flow-card-desc">8-step detailed wizard with simulated payment and confirmation</div>
          <div class="flow-card-source">booking-demo.html</div>
          <div class="flow-card-meta">8 steps â€¢ Good path only (demo)</div>
        </button>
      </div>

      <button class="btn btn-primary" onclick="alert('Export coming soon')">Export feedback</button>
    </div>

    <!-- Flow Detail -->
    <div class="view flow-detail-view" id="flowDetail">
      <h1 class="view-title" id="flowTitle"></h1>
      <p class="view-subtitle" id="flowSource"></p>

      <div class="path-toggle" id="pathToggle">
        <button class="path-btn good active" type="button" onclick="switchPath('good')">Good path</button>
        <button class="path-btn bad" type="button" onclick="switchPath('bad')">Bad path</button>
      </div>

      <div id="screensList"></div>
    </div>

    <!-- Screen Detail -->
    <div class="view detail-view" id="screenDetail">
      <div class="screen-label" id="detailLabel"></div>
      <h1 class="view-title" id="detailTitle"></h1>

      <div id="detailCopy"></div>

      <div class="copy-box">
        <div class="copy-box-title">Review question</div>
        <div class="copy-box-content" id="detailReview"></div>
      </div>

      <div id="voiceRecorded" style="display:none;" class="copy-box">
        <div class="copy-box-title">Your comment</div>
        <div class="copy-box-content">Voice note recorded</div>
      </div>
    </div>
  </div>

  <div class="footer" id="footer">
    <button class="btn btn-primary" id="actionBtn" onclick="handleAction()">Record voice note</button>
  </div>

  <canvas id="screenshotCanvas" style="display:none;"></canvas>

  <script>
    const flowsData = {
      funnel: {
        title: 'Event-Type Funnel',
        source: 'event-type-funnel.html',
        screens: {
          good: [
            {
              step: 'Step 1 of 3',
              title: 'Event Type Selection',
              question: 'What are you celebrating?',
              copy: {
                heading: 'What are you celebrating?',
                subtitle: 'This helps us recommend the perfect package for your event',
                options: [
                  'ðŸŽ‰ Bridal Shower - Most popular',
                  'ðŸ‘¶ Baby Shower - Intimate celebrations',
                  'ðŸŽ‚ Birthday (Milestone) - 30th, 40th, 50th...',
                  'ðŸŽˆ Birthday (Casual) - Friends & family',
                  'ðŸ’¼ Corporate Event - Meetings, team building',
                  'âœ¨ Other - Tell us more'
                ]
              },
              review: 'Are these categories intuitive? Anything missing?'
            },
            {
              step: 'Step 2 of 3',
              title: 'Guest Count',
              question: 'How many guests?',
              copy: {
                heading: 'How many guests?',
                subtitle: 'We can accommodate up to 50 guests',
                input: 'Number input (1-50)',
                warning: 'For 40-50 guests: "We have flexible options. We'll help you make it work!"'
              },
              review: 'Is the warning helpful or concerning?'
            },
            {
              step: 'Step 3 of 3',
              title: 'Date Selection',
              question: 'When is your event?',
              copy: {
                heading: 'When is your event?',
                subtitle: 'Most people book 2-3 months in advance',
                input: 'Date picker (min: today)',
                checkbox: 'â˜ I'm flexible on the exact date'
              },
              review: 'What do you do with the "flexible date" info?'
            },
            {
              step: 'Step 4',
              title: 'Package Recommendation',
              question: 'Recommended package displayed',
              copy: {
                heading: 'Perfect! Here's our recommendation:',
                recommended: 'â­ Recommended for You\nHalf-Day Package\n4:00 PM â€“ 10:00 PM\nÂ£465\n6 hours',
                reasoning: 'Why we recommend this:\nâœ“ 8 of 12 bridal showers chose this package\nâœ“ Allows time for setup, food, games, photos, and cleanup\nâœ“ 2 customers who booked 4 hours asked for more time â€” don't make that mistake!',
                alternatives: 'Also available:\n4 Hours â€” Â£345 (âš ï¸ Often not enough for events with 20+ guests)\nFull-Day (10am-10pm) â€” Â£885 (Great if you need morning setup time + evening event)'
              },
              review: 'Does the recommendation reasoning feel helpful or pushy?'
            }
          ],
          bad: [
            {
              step: 'Step 1 Error',
              title: 'No selection made',
              question: 'User tries to proceed without choosing',
              copy: {
                error: 'MISSING: No error shown. Button simply doesn't work.',
                issue: 'User clicks "Next" but nothing happens. No feedback.'
              },
              review: 'Should we show "Please select an event type" message?'
            },
            {
              step: 'Step 2 Error',
              title: 'Invalid guest count',
              question: 'User enters 0 or >50',
              copy: {
                error: 'MISSING: HTML5 validation prevents this, but no error message shown',
                issue: 'Input just won't accept invalid numbers. Silent failure.'
              },
              review: 'Should we show "Guest count must be 1-50" message?'
            },
            {
              step: 'Step 3 Error',
              title: 'Past date selected',
              question: 'User tries to pick yesterday',
              copy: {
                error: 'MISSING: HTML5 min date prevents this, but no explanation',
                issue: 'Past dates are disabled in picker. User might not know why.'
              },
              review: 'Should we explain why some dates are disabled?'
            },
            {
              step: 'Step 4 Error',
              title: 'Acuity redirect fails',
              question: 'Book button doesn't open Acuity',
              copy: {
                error: 'MISSING: No fallback. User clicks button, nothing happens.',
                issue: 'If Acuity is down or blocked, booking flow dead-ends.',
                consequence: 'Lost customer. No way to complete booking.'
              },
              review: 'Should we add: "Having trouble? Call us: 020..." fallback?'
            }
          ]
        }
      },
      main: {
        title: 'Category-Based Flow (Live)',
        source: 'index.html (production)',
        screens: {
          good: [
            {
              step: 'Step 1',
              title: 'Category Selection',
              question: 'Choose booking category',
              copy: {
                heading: 'Ready to book your session?',
                subtitle: 'Select your category below. A 50% reservation fee invoice will be emailed within 48 hours.',
                categories: [
                  'Studio Viewing - Free â€¢ 20 mins',
                  'Event Hire - Â£345 - Â£885',
                  'Workshops & Content - Â£90 - Â£645',
                  'Proposal Packages - Â£770 - Â£1,700 (Launch Offer)'
                ]
              },
              review: 'Are categories clear? Is deposit info prominent enough?'
            },
            {
              step: 'Step 2',
              title: 'Package Selection (Event Hire)',
              question: 'Choose specific package',
              copy: {
                heading: 'Event Hire Options',
                info: 'Suitable for: Corporate events, Supperclubs, Wellness, Brand launches, Private events, Intimate birthday dinners, Bridal & baby showers\nIncluded: Kitchen (Fridge, oven, cooking hob, dishwasher), 10 tables, 40 chairs',
                packages: [
                  '4hrs Flexi - Â£345 - 4 hours - Ideal for focused events',
                  'Half-Day - Â£465 - 6 hours - (10am-4pm OR 4pm-10pm)',
                  '8hrs Flexi - Â£645 - 8 hours - Flexible timing',
                  'Full-Day (MOST POPULAR) - Â£885 - 12 hours - (10AM-10PM)',
                  'Late Finish - Â£845 - 8 hours - (4pm-midnight)'
                ]
              },
              review: 'Do descriptions help choose? Is "Most Popular" badge helpful?'
            },
            {
              step: 'Step 3',
              title: 'Acuity Modal',
              question: 'External booking system',
              copy: {
                modal: 'Modal opens with:\nHeader: "Book Your Session - Hibiscus Studio"\nIframe: Acuity scheduler embedded\nClose: [X] button top-right',
                acuity: 'Acuity shows:\nâ€¢ Calendar picker\nâ€¢ Available time slots\nâ€¢ Form: Name, Email, Phone\nâ€¢ "Complete Booking" button'
              },
              review: 'Does modal feel disconnected? Hard to use on mobile?'
            }
          ],
          bad: [
            {
              step: 'Error 1',
              title: 'Modal won't open',
              question: 'Book Now button broken',
              copy: {
                error: 'MISSING: If modal fails to open, no error shown',
                issue: 'User clicks "Book Now", nothing happens. Dead end.',
                cause: 'JavaScript error, popup blocker, or Acuity script fails to load'
              },
              review: 'Should we show: "Booking system unavailable. Email us at..." ?'
            },
            {
              step: 'Error 2',
              title: 'Acuity calendar empty',
              question: 'No availability shown',
              copy: {
                error: 'SHOWN BY ACUITY: "No times available"',
                issue: 'Calendar shows month but all dates are grayed out',
                cause: 'You haven't set availability, or all slots booked'
              },
              review: 'Should we warn before modal opens if calendar is empty?'
            },
            {
              step: 'Error 3',
              title: 'Booking completes but no invoice',
              question: '48-hour invoice never arrives',
              copy: {
                error: 'MISSING: No system to track if invoice was sent',
                issue: 'Customer books, waits, never gets invoice, booking expires',
                cause: 'Manual process - you forgot to send invoice, or email bounced',
                consequence: 'Customer thinks they're booked. You have no record. Conflict on event day.'
              },
              review: 'Should we automate invoice sending? Add reminder system?'
            }
          ]
        }
      },
      demo: {
        title: 'Booking Demo Wizard',
        source: 'booking-demo.html (prototype)',
        screens: {
          good: [
            {
              step: 'Step 1',
              title: 'Event Type',
              question: 'What are you planning?',
              copy: {
                heading: 'What are you planning?',
                options: [
                  'Bridal shower - Celebrate your big day',
                  'Private party - Birthday, celebration, dinner',
                  'Workshop - Teach a class or host a session'
                ]
              },
              review: 'Clear options?'
            },
            {
              step: 'Step 2-4',
              title: 'Timeframe, Day Type, Date',
              question: 'When are you booking?',
              copy: {
                flow: 'Step 2: This month / Next 1-2 months / Later\nStep 3: Weekend / Weekday\nStep 4: Pick specific date from available dates'
              },
              review: 'Is 3 steps too many for date selection?'
            },
            {
              step: 'Step 5',
              title: 'Time Selection',
              question: 'Choose your time',
              copy: {
                heading: 'Choose your time',
                slots: [
                  '12pm - 6pm - Â£465 - Afternoon',
                  '2pm - 8pm - Â£465 - Afternoon-Evening',
                  '4pm - 10pm - Â£465 - Evening (MOST POPULAR)',
                  '6pm - 12am - Â£645 - Night'
                ],
                expandable: 'Tap to see breakdown:\nâ€¢ 4.5 hours of memories\nâ€¢ Tearful speeches: at least 2\nâ€¢ First dance practice: unlimited\nâ€¢ Photos you'll love: hundreds'
              },
              review: 'Is the emotional copy helpful or cheesy?'
            },
            {
              step: 'Step 6-7',
              title: 'Guest Count & Contact',
              question: 'Your details',
              copy: {
                guests: '1-10 (intimate) / 11-20 (small) / 21-30 (medium) / 31-40 (max)',
                form: 'Name, Email, Phone\n"âœ¨ Auto-fill for demo" button\nReal-time validation with âœ“ checkmarks'
              },
              review: 'Is validation clear? Good form UX?'
            },
            {
              step: 'Step 8-9',
              title: 'Review & Confirmation',
              question: 'Final confirmation',
              copy: {
                review: 'Summary: Event, Date, Time, Guests, Name\n50% reservation fee: Â£233\nRemaining Â£233 due 7 days before\nWhat's included: 40 chairs, 10 tables, Bluetooth speaker, Wi-Fi, Kitchen, Toilet',
                confirmation: 'âœ“ Booking Confirmed!\nWe've sent confirmation to your email.\nSee you soon at Hibiscus Studio!'
              },
              review: 'Is payment flow clear? Good confirmation message?'
            }
          ]
        }
      }
    };

    let currentView = 'flows';
    let currentFlow = null;
    let currentPath = 'good';
    let currentScreen = null;
    let recordingState = 'idle'; // idle, recording, recorded
    let feedback = JSON.parse(localStorage.getItem('hb_verified_feedback')) || {};
    let mediaRecorder = null;
    let audioChunks = [];

    function openFlow(flowId) {
      console.log('Opening flow:', flowId);
      currentFlow = flowId;
      currentView = 'flow-detail';
      currentPath = 'good';
      render();
    }

    function switchPath(path) {
      console.log('Switching to path:', path);
      currentPath = path;

      // Update button states
      const goodBtn = document.querySelector('.path-btn.good');
      const badBtn = document.querySelector('.path-btn.bad');

      if (goodBtn && badBtn) {
        goodBtn.classList.toggle('active', path === 'good');
        badBtn.classList.toggle('active', path === 'bad');
      }

      renderScreensList();
    }

    function goBack() {
      if (currentView === 'screen-detail') {
        currentView = 'flow-detail';
        currentScreen = null;
        recordingState = 'idle';
      } else if (currentView === 'flow-detail') {
        currentView = 'flows';
        currentFlow = null;
      }
      render();
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    function render() {
      document.getElementById('flowsView').classList.remove('active');
      document.getElementById('flowDetail').classList.remove('active');
      document.getElementById('screenDetail').classList.remove('active');

      const footer = document.getElementById('footer');

      if (currentView === 'flows') {
        document.getElementById('flowsView').classList.add('active');
        document.getElementById('breadcrumb').textContent = 'All Flows';
        document.getElementById('backBtn').style.display = 'none';
        footer.style.display = 'block';
        document.getElementById('actionBtn').textContent = 'Export feedback';
        document.getElementById('actionBtn').className = 'btn btn-primary';
      } else if (currentView === 'flow-detail') {
        document.getElementById('flowDetail').classList.add('active');
        const flow = flowsData[currentFlow];
        document.getElementById('flowTitle').textContent = flow.title;
        document.getElementById('flowSource').textContent = 'Source: ' + flow.source;
        document.getElementById('breadcrumb').textContent = flow.title;
        document.getElementById('backBtn').style.display = 'block';
        footer.style.display = 'none';

        // Show/hide path toggle based on whether bad path exists
        const hasBadPath = flow.screens.bad && flow.screens.bad.length > 0;
        document.getElementById('pathToggle').style.display = hasBadPath ? 'flex' : 'none';

        // Update path toggle active state
        const goodBtn = document.querySelector('.path-btn.good');
        const badBtn = document.querySelector('.path-btn.bad');
        if (goodBtn && badBtn) {
          goodBtn.classList.toggle('active', currentPath === 'good');
          badBtn.classList.toggle('active', currentPath === 'bad');
        }

        renderScreensList();
      } else if (currentView === 'screen-detail') {
        document.getElementById('screenDetail').classList.add('active');
        document.getElementById('breadcrumb').textContent = flowsData[currentFlow].title;
        document.getElementById('backBtn').style.display = 'block';
        footer.style.display = 'block';
        renderScreenDetail();
        renderFooterForScreen();
      }
    }

    function renderScreensList() {
      const flow = flowsData[currentFlow];
      const screens = flow.screens[currentPath] || [];
      const list = document.getElementById('screensList');

      if (screens.length === 0) {
        list.innerHTML = '<div style="padding: 20px; color: var(--color-text-dim);">No screens available for this path</div>';
        return;
      }

      list.innerHTML = screens.map((screen, idx) => `
        <button class="screen-card" type="button" onclick="openScreen(${idx})">
          <div class="screen-label">${screen.step}</div>
          <div class="screen-title">${screen.title}</div>
          <div class="screen-desc">${screen.question}</div>
        </button>
      `).join('');
    }

    function openScreen(idx) {
      currentScreen = idx;
      currentView = 'screen-detail';
      recordingState = 'idle';
      render();
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    function renderScreenDetail() {
      const flow = flowsData[currentFlow];
      const screen = flow.screens[currentPath][currentScreen];
      const feedbackKey = `${currentFlow}_${currentPath}_${currentScreen}`;
      const hasFeedback = feedback[feedbackKey] && feedback[feedbackKey].recorded;

      document.getElementById('detailLabel').textContent = screen.step;
      document.getElementById('detailTitle').textContent = screen.title;
      document.getElementById('detailReview').textContent = screen.review;

      // Render copy sections
      const copyContainer = document.getElementById('detailCopy');
      let copyHTML = '';

      for (const [key, value] of Object.entries(screen.copy)) {
        if (typeof value === 'string') {
          copyHTML += `
            <div class="copy-box">
              <div class="copy-box-title">${key}</div>
              <div class="copy-box-content">${value.replace(/\n/g, '<br>')}</div>
            </div>
          `;
        } else if (Array.isArray(value)) {
          copyHTML += `
            <div class="copy-box">
              <div class="copy-box-title">${key}</div>
              <div class="copy-box-content">${value.map(v => 'â€¢ ' + v).join('<br>')}</div>
            </div>
          `;
        }
      }

      copyContainer.innerHTML = copyHTML;

      // Show/hide recorded voice note
      document.getElementById('voiceRecorded').style.display = hasFeedback ? 'block' : 'none';
    }

    function renderFooterForScreen() {
      const feedbackKey = `${currentFlow}_${currentPath}_${currentScreen}`;
      const hasFeedback = feedback[feedbackKey] && feedback[feedbackKey].recorded;
      const btn = document.getElementById('actionBtn');

      if (recordingState === 'idle') {
        if (hasFeedback) {
          btn.textContent = 'Continue to next screen';
          btn.className = 'btn btn-primary';
        } else {
          btn.textContent = 'Record voice note';
          btn.className = 'btn';
        }
      } else if (recordingState === 'recording') {
        btn.textContent = 'Tap to stop recording';
        btn.className = 'btn';
      } else if (recordingState === 'recorded') {
        btn.textContent = 'Confirm and continue';
        btn.className = 'btn btn-primary';
      }
    }

    function handleAction() {
      const feedbackKey = `${currentFlow}_${currentPath}_${currentScreen}`;
      const hasFeedback = feedback[feedbackKey] && feedback[feedbackKey].recorded;

      if (currentView === 'flows') {
        exportFeedback();
      } else if (currentView === 'screen-detail') {
        if (recordingState === 'idle') {
          if (hasFeedback) {
            moveToNextScreen();
          } else {
            startRecording();
          }
        } else if (recordingState === 'recording') {
          stopRecording();
        } else if (recordingState === 'recorded') {
          confirmAndContinue();
        }
      }
    }

    async function startRecording() {
      recordingState = 'recording';
      renderFooterForScreen();

      try {
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        mediaRecorder = new MediaRecorder(stream);
        audioChunks = [];

        mediaRecorder.ondataavailable = (e) => audioChunks.push(e.data);
        mediaRecorder.onstop = () => {
          const blob = new Blob(audioChunks, { type: 'audio/webm' });
          saveVoiceNote(blob);
          captureScreenshot();
          recordingState = 'recorded';
          renderFooterForScreen();
        };

        mediaRecorder.start();
      } catch (err) {
        alert('Microphone access required. Please allow microphone access in your browser settings.');
        recordingState = 'idle';
        renderFooterForScreen();
      }
    }

    function stopRecording() {
      if (mediaRecorder && mediaRecorder.state === 'recording') {
        mediaRecorder.stop();
      }
    }

    function saveVoiceNote(blob) {
      const reader = new FileReader();
      reader.onloadend = () => {
        const feedbackKey = `${currentFlow}_${currentPath}_${currentScreen}`;
        if (!feedback[feedbackKey]) feedback[feedbackKey] = {};
        feedback[feedbackKey].voiceNote = reader.result;
        feedback[feedbackKey].timestamp = new Date().toLocaleString();
        localStorage.setItem('hb_verified_feedback', JSON.stringify(feedback));
      };
      reader.readAsDataURL(blob);
    }

    function captureScreenshot() {
      const canvas = document.getElementById('screenshotCanvas');
      const ctx = canvas.getContext('2d');
      canvas.width = window.innerWidth * window.devicePixelRatio;
      canvas.height = window.innerHeight * window.devicePixelRatio;
      ctx.scale(window.devicePixelRatio, window.devicePixelRatio);

      const screenshotData = canvas.toDataURL('image/png');
      const feedbackKey = `${currentFlow}_${currentPath}_${currentScreen}`;
      if (!feedback[feedbackKey]) feedback[feedbackKey] = {};
      feedback[feedbackKey].screenshot = screenshotData;
      localStorage.setItem('hb_verified_feedback', JSON.stringify(feedback));
    }

    function confirmAndContinue() {
      const feedbackKey = `${currentFlow}_${currentPath}_${currentScreen}`;
      if (!feedback[feedbackKey]) feedback[feedbackKey] = {};
      feedback[feedbackKey].recorded = true;
      localStorage.setItem('hb_verified_feedback', JSON.stringify(feedback));

      renderScreenDetail();
      moveToNextScreen();
    }

    function moveToNextScreen() {
      const flow = flowsData[currentFlow];
      const screens = flow.screens[currentPath];

      if (currentScreen < screens.length - 1) {
        currentScreen++;
        recordingState = 'idle';
        render();
        window.scrollTo({ top: 0, behavior: 'smooth' });
      } else {
        // Done with this path, go back to flow detail
        currentView = 'flow-detail';
        currentScreen = null;
        recordingState = 'idle';
        render();
        window.scrollTo({ top: 0, behavior: 'smooth' });
      }
    }

    function exportFeedback() {
      const exportData = {
        reviewSession: new Date().toISOString(),
        feedback: feedback
      };

      const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `hb-verified-review-${new Date().toISOString().split('T')[0]}.json`;
      a.click();
    }


    // Initialize
    render();
  </script>
</body>
</html>
